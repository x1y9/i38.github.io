<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <title>微动手势插件开发指南</title>
	<style>
	code {width: 100%;word-break: break-all;font-size:15px;}
	h4 {margin-bottom:3px;font-size:20px;}
       red {color:#f00;}
	.toast {position:fixed;bottom:20%;background-color:#333;color:#fff;padding:10px;}
	</style>
  </head>
  <body>

<h4>简介</h4>
<code>微动手势的插件有很多种，主要有以下几种：<br/>
* 所有的普通指令都是一个插件，可以在插件输入框里直接输入指令和参数，参考附录一。<br/>
* intent:开头的是安卓的intent url，可以直接作为插件录入。<br/>
* ss:开头的是微动手势的超级捷径，可以理解为一组连续执行的微动指令，这是微动手势最有特色的部分，下面详细介绍。<br/><br/>

注意插件是<red>区分大小写</red>的，并且格式中的标点符号必须使用<red>英文标点符号</red>。微动手势的自动化功能也支持触发一个连续动作，也使用上述几种插件。<br/>
</code>

<h4>超级捷径</h4>
<code>微动手势的<red>4.3.4版本</red>之后支持了超级捷径，举一个简单的例子：<br/>
<red>ss:[{"a":"com.tencent.mm"}]</red><br/>
就是一个简单的超级捷径，用来启动微信。这里ss:后面的中括号括起来的部分是一个json格式的数组，json格式详细说明请请参考附录二。<br/><br/>
每个超级捷径都是用<red>中括号</red>括起来的一组指令，其中单条指令则是以<red>大括号</red>括起来的一个json对象，对象包括一些属性，比如"a"就是一个属性，表示这条指令要做的动作，后面的"com.tencent.mm"就是这个动作的值，这是一个安卓版微信的package id，就表示启动微信。下面会详细解释插件指令的格式。
</code>

<h4>指令对象</h4>
<code>每个指令对象，可以包括以下几个属性:<br/>
1. "a"表示要执行的动作，这个属性最复杂，除了上面所述的安卓package id，还可以取很多值，参考附录一，但是注意这个值<red>区分大小写</red>，不要弄混。<br/>
2. "d"表示延时，单位为毫秒，在微动手势的<red>5.5.4版本</red>之前，这个延时分为正负延时，正延时是在执行后，负延时是在执行前延时，<red>5.5.4版本</red>之后不再区分，统一为执行前延时，负值也不再有意义。<br/>
3. "n"表示要匹配的屏幕元素。<br/>
4. "p"表示要匹配的屏幕元素所在的package。<br/>
5. "t"表示这个指令的超时时间，单位为毫秒，不能超过8000(即8秒)，超过8秒整个超级捷径会中止。<br/>
6. "j"表示跳转(<red>5.7.0版本</red>)，可以根据上一条指令的执行结果往下跳转N条指令，取值为两个数，分别表示成功和失败的时候跳转的指令数，比如 {"j":"1,2"}表示上条匹配成功，往下跳一条，失败则往下跳2条指令，注意如果希望匹配失败，上一条的匹配指令必须设置t超时。<br/>
</code>

<h4>连续动作</h4>
<code>根据指令对象的定义，我们可以定义一些连续指令，比如：<br/>
<red>ss:[{"a":"2"},{"a":"click:150:150","d":300}]</red><br/>
表示先回到主屏，再点击屏幕上150，150这个坐标点，这里两个指令都用大括号括起来，并以逗号分隔就可以了。<br/>
另外注意这里第二个指令加了一个d延时300毫秒，是考虑回主屏通常有动画，所以加一个延时确保动画已经完成。
</code>

<h4>界面匹配</h4>
<code>有的时候我们希望匹配界面的某个元素，再执行相应的动作，比如：<br/>
<red>ss:[{"a":"com.tencent.mm"},{"a":"k","n":"发现"},{"a":"k:10","n":"朋友圈"}]</red><br/>
这条插件有三个指令，第一条是通过package id启动微信，第二条指令有个n属性，<red>"n":"发现"</red>就表示匹配"发现"这个界面元素，匹配成功后回执行"k"动作，参考附录一，我们知道k动作就是点击这个匹配到的元素，所以相当于是在微信启动以后，点击"发现"，然后第三条指令，就是匹配"朋友圈"并点击，这里的点击写成k:10是因为微信的界面嵌套过于复杂，需要控制点击深度，请参考下面的点击模式。所以整个这条超级捷径的作用就是一步进入微信朋友圈。<br/><br/>

注意，这里的两个匹配指令都不需要加延时了，因为都是在匹配成功才点击，而匹配成功的时候，界面已经加载好了，所以不需要延时，另外，因为匹配后通常都是普通的点击，我们可以省略普通的点击动作，整个插件即简化为：<br/>
<red>ss:[{"a":"com.tencent.mm"},{"n":"发现"},{"a":"k:10","n":"朋友圈"}]</red><br/><br/>

我们也可以增加条件指令，从而在匹配成功和失败时执行不同的指令，比如<red>ss:[{"a":"2"},{"n":"支付宝","t":2000},{"j":"0,1"},{"n":"微信"}]</red>表示回到桌面，尝试点击支付宝，如果没有匹配到，则点击微信。
</code>

<h4>匹配模式</h4>
<code>匹配界面元素有多种方式：<br/>
* 严格匹配，比如<red>{"n":"发现"}</red>就是仅匹配一个内容正好为"发现"的元素。<br/>
* 模糊匹配，比如<red>{"n":"~发现"}</red>就是匹配内容包含"发现"的元素，如果有多个元素，返回第一个匹配的。<br/>
* Id匹配，比如<red>{"n":"#action"}</red>就是匹配一个id为"action"的元素，这个id是安卓界面元素的一个属性。<br/>
* 查找匹配，比如<red>{"n":"^发现"}</red>这是一种特殊方式，如果界面上有这个元素，但上面两种都不匹配，可以用这个试试。<br/>

</code>

<h4>匹配过滤器</h4>
<code>某些情况下如果匹配了多个界面元素，可以通过加filter过滤器("f"属性)来选择想要的元素，过滤器以分号分割多个条件，条件可以是v(可见),c(可点击),e(可编辑),w(宽度),h(高度),x/y(中心坐标),x1/y1/x2/y2(左上和右下角坐标)，下面分别解释：<br/>
* 可见过滤，比如<red>v</red>就是仅匹配屏幕上可见的元素，也可以写成v=1，如果要匹配不可见元素，需要写成v=0。<br/>
* 位置过滤，比如<red>x1=800</red>就是仅匹配中心x坐标位于800的元素。<br/>
* 大小过滤，比如<red>w>100;h=200</red>就是仅匹配宽度大于100，且高度等于200的元素。<br/><br/>
举个完整的例子，<red>{"n":"发现","f":"v;x=800"}</red>就是仅匹配屏幕上可见并且中心x坐标为800的"发现"元素，忽略其他"发现"。
</code>

<h4>像素匹配</h4>
<code> 由于安卓无障碍的限制，某些应用的界面元素难以匹配，尤其是一些使用webview的应用，比如微信小程序，支付宝小程序等，对于这类应用的匹配，<red>5.6.0版本</red>微动手势提供的另一种匹配模式，像素匹配，这种模式使用屏幕上的像素逐点匹配，可以匹配预先定义的任意个像素点，理论上这种模式可以应对任何类型的应用，像素匹配依然使用"n"属性，但是以@打头，后面加上坐标和颜色，比如：<br/>
* <red>{"n":"@100,100,ffffff"}</red>就匹配100,100这个白色像素点，颜色格式是十六进制RGB格式，ffffff就是白色。<br/>
* <red>{"n":"@100,100,a0a0a0,100,101,ececec"}</red>匹配两个像素点，分别为100,100和100,101，两个颜色不同的像素匹配可以极大降低误匹配的概率。<br/><br/>

由于安卓的限制，像素匹配需要先在微动实验室里启用并给与授权，并且在每次重启微动后都需要再授权，另外要注意：<br/>
* 像素匹配模式下过滤器是无效的。<br/>
* 像素匹配仅在超级捷径下可用，在自动化的元素匹配里不支持像素匹配。<br/>
</code>

<h4>点击模式</h4>
<code>大部分匹配成功后执行的动作都是点击，也就是"k"动作，这个动作可以通过参数控制点击模式<br/>
* 常规模式(参数为0)，比如<red>{"a":"k:0","n":"发现"}</red>，如果元素可以点击，直接触发点击，否则就使用元素在屏幕上的位置来计算一个中心坐标进行模拟点击。<br/>
* 递归模式(参数大于0)，比如<red>{"a":"k:5","n":"发现"}</red>，如果元素可以点击，直接触发点击，否则往上逐级递归看父元素是否可以点击，最多递归5级父元素，这种模式下不会进行坐标点击。<br/>
* 仅坐标模式(参数小于0)，比如<red>{"a":"k:-1","n":"发现"}</red>，会在匹配成功后直接使用元素在屏幕上的位置来计算一个中心坐标进行模拟点击，不管这个元素是否可以点击。<br/><br/>

如果不带任何参数，那么又分两种情况：<br/>
* 自动化里，默认使用上面的常规模式，因为自动化的使用场景里，很多时候需要模拟坐标点击才能成功。<br/>
* 超级捷径里，默认使用上面的递归模式(k:9)，因为超级捷径的使用场景里，基于元素或父元素的点击更常见，当然你可以通过代码加参数来适配自己的场景。<br/><br/>

微动手势的<red>5.6.7版本</red>之后增加了偏移量点击，需要带两个参数，表示在元素中心点上xy坐标的偏移量，比如：<br/>
<red>{"a":"k:10:-50","n":"发现"}</red>就会在匹配到的元素中心坐标基础上，x加10，y减去50，并模拟点击。
</code>

<h4>变量</h4>
<code>一些支持参数的命令，可以使用变量作为参数的一部分，微动目前支持的全局变量有：<br/>
* {trigger}，标识自动化的触发器来源，比如通知触发，就表示通知的内容，界面触发，就表示界面的文字。<br/>
* {date}，表示当前日期，比如<red>V:{date}</red>指令可以插入当前的日期。<br/>
* {time}，表示当前时间。<br/>
* {datetime}，表示当前日期和时间。<br/><br/>

变量可以使用re命令进行正则表达式转换，生成新的变量，格式为re:源变量:新变量:group:正则表达式，举例如下：<br/>
* <red>re:trigger:code:0:[0-9]{4,6}</red>就是在<red>trigger</red>变量中识别出4到6位数字，并放入一个新的<red>code</red>变量中。<br/>
</code>

<h4>应用举例</h4>
<code><red>ss:[{"a":"com.tencent.mm"},{"n":"发现"},{"n":"小程序","d":1000},{"n":"^我的小程序"}]</red><br/>
这个超级捷径用于直接打开微信我的小程序界面，有几点说明：<br/>
* 第三步点击"小程序"前延时1秒，是因为微信这个界面有个动态加载过程，过早点击，会进入其他功能项，所以必须延时后点击。<br/>
* 第四步匹配需要用^模式，否则匹配不了，这是因为微信这个界面很复杂导致的。<br/><br/>
</code>

<code><red>ss:[{"a":"3"},{"p":"com.miui.home","n":"#clearAnimView"}]</red><br/>
这个超级捷径用于触发MIUI的后台清理动作。<br/>
* 第一步的指令3，请参考附录一，这是用来打开多任务界面。<br/>
* 第二步就是触发清理按钮，这个按钮是有id的，所以直接使用#来匹配id，但安卓的控件id是带package的，所以用"p"属性指定package。<br/><br/>
</code>

<code><red>ss:[{"a":"com.tencent.mm"},{"n":"行程卡"},{"a":"click:500:1500","d":"3000"},{"a":"click:500:1700","d":500}]</red><br/>
这个捷径用于打开微信的行程卡，执行之前先确保手工打开过一次。<br/>
* 第三步是通过模拟点击选中“同意...”选框，为了等待页面加载完成，需要等待足够的时间，这里是等了3秒，点击的坐标需要根据特定手机布局进行修改。<br/>
* 最后一步click的坐标同样需要根据布局调整，加上一个延时500毫秒，是因为上一步的点击同意后，这个按钮要等一会才能点击。<br/><br/>
</code>

<code><red>ss:[{"a":"com.android.browser"},{"n":"京东"},{"n":"^京东超市"}]</red><br/>
这个捷径用于打开网页版的京东超市。<br/>
* 第二步匹配的京东来自于浏览器首页上一个京东书签，如果你的浏览器首页没有这个书签，这一步就会超时。<br/>
* 第三步此时已经打开京东首页，要匹配浏览器里的元素"京东超市"，必须使用^模式。<br/><br/>
</code>

<code><red>ss:[{"a":"re:trigger:code:0:[0-9]{4,6}"},{"a":"X:{code}"}]</red><br/>
这个捷径用于验证码自动复制，需要在微动的自动化里添加一条通知触发，识别短信App，匹配"验证码"，然后触发上面这个动作。<br/>
* 第一步的re命令用于在完整的短信中匹配出4到6位数字的验证码。<br/>
* 然后通过X命令设置到剪贴板里，这里通过变量的方式引用了上一步正则表达式的结果<red>{code}</red>。<br/><br/>
</code>

<h4>附录一：支持的动作</h4>
<code>
注: 老版本微动手势不一定支持下表的所有动作和参数，所有的动作名称和参数都是<red>区分大小写</red>的，如果有参数，大部分参数使用<red>英文冒号</red>来分割。<br/>
"1" - 返回<br/>
"2" - 主页<br/>
"3" - 多任务<br/>
"4" - 下拉通知<br/>
"C" - 下拉通知，再触发一次关闭通知<br/>
"5" - 快速设置<br/>
"6" - 上一任务<br/>
"7" - 电源菜单<br/>
"8" - 语音助手<br/>
"9" - 分屏<br/>
"a" - 播放暂停<br/>
"n" - 播放下一曲<br/>
"r" - 播放上一曲<br/>
"b" - 支付宝扫码<br/>
"c" - 支付宝付款码<br/>
"d" - 微信扫码<br/>
"e" - 截屏<br/>
"f" - 弹出面板<br/>
"g" - 屏幕上划，参考附录三。<br/>
"h" - 屏幕下划，参考附录三。<br/>
"i" - 屏幕左划，参考附录三。<br/>
"j" - 屏幕右划，参考附录三。<br/>
"G" - 滚动条上滚动，参考附录三。<br/>
"H" - 滚动条下滚动，参考附录三。<br/>
"k" - 点击匹配到的界面元素<br/>
"l" - 锁屏<br/>
"m" - 触发飞鼠等工具，参考参考附录六<br/>
"o" - 音量加<br/>
"q" - 音量减<br/>
"u" - 弹出音量调节界面<br/>
"p" - 暂停体感手势，再触发一次可以恢复。<br/>
"s" - 停止所有手势<br/>
"t" - 强制横屏<br/>
"K" - 强制竖屏<br/>
"v" - 设置自动亮度<br/>
"w" - 亮度增加<br/>
"x" - 亮度减低<br/>
"y" - 切换输入法<br/>
"A" - 自动旋转 <br/>
"B" - 不自动旋转<br/>
"D" - 开关wifi<br/>
"E" - 开关蓝牙<br/>
"U" - 开关定位<br/>
"L" - 开关NFC<br/>
"F" - 开关闪光灯<br/>
"I" - 左手单手模式<br/>
"M" - 右手单手模式  <br/>
"J" - 铃声模式<br/>
"O" - 网络控制面板<br/>
"P" - 微信付款码<br/>
"Q" - 保持屏幕常亮<br/>
"R" - 屏幕禁止触摸<br/>
"click" - 屏幕点击，参考附录三。<br/>
"N" - 任意划屏， 参考附录三。<br/>
"V" - 输入文本，<red>5.4.6版本</red>支持，参考附录四。<br/>
"W" - 发送通知，<red>5.6.3版本</red>支持，参考附录四。<br/>
"X" - 设置剪贴板，<red>5.5.5版本</red>支持，参考附录四。<br/>
"T" - 模拟多点触摸，<red>5.5.3版本</red>支持，参考附录五。<br/>
</code>

<h4>附录二：JSON格式</h4>
<code>
JSON是一种轻量的数据表示方法，采用key:value的方式记录数据，非常直观，也容易扩展。key是属性名，必须用双引号引起来，value是属性值，可以是以下类型之一：<br/>
* 数字（整数或浮点数）<br/>
* 字符串（在双引号中）<br/>
* 逻辑值（true 或 false）<br/>
* 数组（在方括号中）<br/>
* 对象（在花括号中）<br/>
* null<br/><br/>

JSON的数组和对象是可以嵌套的，进而表示复杂的数据，比如：
<pre>
{
"employees": [
  { "firstName":"John" , "lastName":"Doe" },
  {"firstName":"Anna" , "lastName":"Smith" },
  { "firstName":"Peter" , "lastName":"Jones" }
 ]
}
</pre>
这是一个对象，只有一个属性employees，取值是一个数组（中括号括起来的部分），数组中有三个对象（大括号括起来的部分），每个对象又包括两个属性，分别为firstName和lastName。
</code>

<h4>附录三：重复模拟手势</h4>
<code>微动手势的<red>5.4.6版本</red>之后一些模拟手势的指令可以通过参数控制是否模拟多次手势，这些指令包括g,h,i,j,G,H,click,N，其中g,h,i,j,G,H都是滚屏的指令，他们的区别是g,h,i,j是模拟了一个滑动手势，四条指令分别对应四个方向，G,H则是通过调节控件的滚动条，并且只支持上下方向。这些指令的具体格式如下：<br/>
* g,h,i,j的参数为:长度:时长:次数:延时，比如<red>g:0.5:200:3:100</red>表示用200毫秒滑动半个屏幕(0.5乘以屏幕高度)，连续3次滑动，每次间隔100毫秒。<br/>
* G,H的参数为:次数:延时，比如<red>G:5:100</red>表示连续5次上滚动，间隔100毫秒，这两条指令通过滚动条来滚动，所以没办法控制单次滚动的幅度，但在控件滚动到头之后之后会自动停止。<br/>
* click点击指令，参数为:x坐标:y坐标:时长:次数:延时，比如<red>click:150:150:800:3:1000</red>表示在坐标点150,150长按800毫秒，连续执行3次，每次延时1000毫秒。<br/>
* N划屏指令，参数为:x1:y1:x2:y2:时长:次数:延时，比如<red>N:150:150:200:300:100:5:500</red>表示在从坐标点150,150滑动到200:300，连续执行5次，每次延时500毫秒。<br/>
<br/>
这些重复指令一旦执行，想要中断，有两个方法：<br/>
* 触发微动手势的p或s指令，也就是暂停或停止，这两个指令都会终止正在执行的重复手势。<br/>
* 如果是在超级捷径中，连续滚动指令后面接着一条n指令，即匹配节点的点击，一旦匹配成功并点击，就会终止正在执行的重复手势。<br/>
</code>

<h4>附录四：文本参数及变量替换</h4>
<code>微动手势的W,V,X等命令，可以携带一个文本参数，这个参数里可以使用任意的变量，变量是用大括号括起来放在参数里的，在执行的时候，变量会被替换为当前的取值。也可以在参数里使用多个变量拼接起来，举几个例子：<br/>
* <red>V:{date}{time}</red>，可以把当前日期和时间插入当前界面中的编辑框里。<br/>
* <red>W:1:执行成功</red>，用于发送一条“执行成功”的通知，注意第一个参数是通知类别，微动目前支持四个，分别是1,2,3,4。<br/>
* <red>X:{code}</red>，把code变量的内容，复制到剪贴板里。<br/><br/>
</code>

<h4>附录五：模拟多点触摸</h4>
<code>T指令可以模拟一个多点触摸手势，参数需要携带多个手指的坐标位置，比如<red>T:10:10:20:20:90:90:100:100:300</red> 表示第一个手指从10:10滑到20:20，第二个手指从90:90滑到100:100，时长300毫秒，如果有更多手指，可以在时长前面继续增加。<br/><br/>
多点触摸暂时不支持重复多次。
</code>

<h4>附录六：开发者工具</h4>
<code>微动手势的<red>5.6.1版本</red>之后增加了布局查看和屏幕取色两个开发者工具，这两个工具和飞鼠公用一个命令字m，通过参数来区分，m或者m:0为飞鼠，m:1为布局查看工具，m:2为取色工具。<br/>
</code>

<h4>附录七：开关参数</h4>
<code>微动手势的<red>5.6.7版本</red>之后增加了部分开关指令的参数，参数可以用0或者off表示关闭，1或者on表示打开，不加参数则是切换，下列的指令支持开关参数。<br/>
* 开关Wifi<br/>
* 开关蓝牙<br/>
* 开关定位<br/>
* 开关NFC<br/>
* 开关闪光灯<br/>
比如<red>E:0</red>表示关闭蓝牙，<red>E:1</red>或<red>E:on</red>表示打开蓝牙，不带参数的<red>E</red>则是切换蓝牙开关。<br/>
</code>

</code>
</body>
</html>